<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Sp√•ra din best√§llning</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f3f4f6;
      --card:#ffffff;
      --muted:#6b7280;
      --text:#111827;
      --border:#e5e7eb;
      --blue:#2563eb;
      --green:#16a34a;
      --greenBg:#ecfdf5;
      --greenBorder:#d1fae5;
      --shadow:0 12px 28px rgba(0,0,0,.06);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      padding:20px;
      background:var(--bg);
      font-family:system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color:var(--text);
    }
    .wrap{
      max-width:980px;
      margin:0 auto;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:22px;
    }
    h1{margin:0 0 8px;font-size:28px;letter-spacing:-.3px}
    p{margin:0 0 16px;color:#4b5563}

    /* Tabs */
    .tabs{
      display:flex;
      gap:6px;
      margin:14px 0 14px;
      background:#e5e7eb;
      padding:4px;
      border-radius:999px;
    }
    .tab{
      flex:1;
      border:none;
      background:transparent;
      padding:10px 12px;
      border-radius:999px;
      font-weight:900;
      cursor:pointer;
      color:var(--text);
      font-size:14px;
    }
    .tab.active{
      background:var(--blue);
      color:#fff;
      box-shadow:0 10px 22px rgba(37,99,235,.22);
    }

    /* Forms */
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    input[type="text"], input[type="email"]{
      flex:1;
      min-width:240px;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid #d1d5db;
      outline:none;
      font-size:14px;
      background:#fff;
    }
    input:focus{
      border-color:var(--blue);
      box-shadow:0 0 0 3px rgba(37,99,235,.12);
    }
    .btn{
      border:none;
      border-radius:12px;
      padding:11px 16px;
      background:var(--blue);
      color:#fff;
      font-weight:950;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:8px;
      box-shadow:0 12px 24px rgba(37,99,235,.18);
      white-space:nowrap;
    }
    .btn:disabled{opacity:.65;cursor:wait}
    .hint{
      margin-top:8px;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }

    /* Error */
    .error{
      display:none;
      margin-top:12px;
      padding:10px 12px;
      border-radius:12px;
      background:#fef2f2;
      border:1px solid #fecaca;
      color:#b91c1c;
      font-weight:800;
      font-size:14px;
    }

    /* Layout */
    .grid{
      margin-top:16px;
      display:grid;
      grid-template-columns:1.05fr .95fr;
      gap:14px;
    }
    @media (max-width:860px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      border:1px solid var(--border);
      background:#f9fafb;
      border-radius:var(--radius);
      padding:14px;
    }

    /* Left Card */
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:950;
      background:var(--greenBg);
      border:1px solid var(--greenBorder);
      color:#065f46;
      margin-bottom:10px;
    }
    .dot{
      width:9px;height:9px;border-radius:999px;background:#22c55e;
      box-shadow:0 0 0 3px rgba(34,197,94,.15);
    }
    .kv{
      display:flex;
      justify-content:space-between;
      gap:12px;
      padding:9px 0;
      border-top:1px dashed #e5e7eb;
    }
    .kv:first-child{border-top:none;padding-top:0}
    .kv span{color:var(--muted)}
    .kv strong{font-weight:950; text-align:right; max-width:64%; word-break:break-word}

    .links{
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }
    .link{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:9px 11px;
      border-radius:12px;
      background:#fff;
      border:1px solid var(--border);
      text-decoration:none;
      color:var(--blue);
      font-weight:950;
    }
    .link:hover{box-shadow:0 10px 20px rgba(0,0,0,.05)}
    .subnote{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }

    /* Right ETA Card */
    .etaTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-end;
    }
    .etaTitle{font-weight:950}
    .badge{
      font-size:12px;
      font-weight:950;
      padding:6px 10px;
      border-radius:999px;
      background:var(--greenBg);
      border:1px solid var(--greenBorder);
      color:#065f46;
    }
    .etaBig{
      margin-top:10px;
      font-size:26px;
      font-weight:1000;
      letter-spacing:-.4px;
    }
    .etaSmall{
      margin-top:6px;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }

    .progressWrap{
      margin-top:14px;
      padding-top:12px;
      border-top:1px solid var(--border);
    }
    .progressTitle{font-weight:950;margin-bottom:8px}
    .barOuter{
      height:10px;
      border-radius:999px;
      background:#e5e7eb;
      overflow:hidden;
      border:1px solid #d1d5db;
    }
    .barInner{
      height:100%;
      width:25%;
      background:var(--blue);
    }
    .barLabel{
      margin-top:8px;
      color:#4b5563;
      font-weight:900;
      font-size:14px;
    }

    /* Timeline */
    h3{margin:18px 0 10px}
    .timeline{
      border-left:2px solid var(--blue);
      padding-left:18px;
      margin-top:6px;
    }
    .event{
      position:relative;
      margin-bottom:16px;
    }
    .event::before{
      content:"";
      position:absolute;
      left:-20px;
      top:3px;
      width:10px;
      height:10px;
      border-radius:999px;
      background:var(--blue);
      border:2px solid #fff;
      box-shadow:0 0 0 2px var(--blue);
    }
    .event-time{font-size:13px;color:var(--muted)}
    .event-status{font-size:14px;font-weight:950}
    .event-location{font-size:13px;color:#4b5563}

    .hidden{display:none}
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Sp√•ra din best√§llning</h1>
    <p>Sp√•ra med ditt 4PX-sp√•rningsnummer eller med ordernummer + e-post.</p>

    <div class="tabs">
      <button class="tab active" id="tabTracking" type="button">Sp√•rningsnummer</button>
      <button class="tab" id="tabOrder" type="button">Ordernummer + e-post</button>
    </div>

    <!-- TRACKING FORM -->
    <form id="trackForm">
      <div class="row">
        <input type="text" id="trackingInput" placeholder="T.ex. 4PX..., BC...CN" autocomplete="off" />
        <button type="submit" class="btn" id="trackBtn">üîé Sp√•ra</button>
      </div>
      <div class="hint">
        Tips: Efter s√∂kning uppdateras l√§nken automatiskt till <b>?tn=...</b> s√• du kan kopiera och skicka till kunden.
      </div>
    </form>

    <!-- ORDER FORM -->
    <form id="orderForm" class="hidden">
      <div class="row">
        <input type="text" id="orderInput" placeholder="Ordernummer, t.ex. 22700" autocomplete="off" />
        <input type="email" id="emailInput" placeholder="E-post som anv√§ndes vid best√§llning" autocomplete="off" />
        <button type="submit" class="btn" id="orderBtn">üîé Sp√•ra</button>
      </div>
      <div class="hint">Ange ditt ordernummer och samma e-postadress som du anv√§nde vid best√§llningen.</div>
    </form>

    <div id="errorBox" class="error"></div>

    <!-- RESULTS -->
    <div id="resultArea" class="hidden">
      <div class="grid">
        <!-- LEFT: TECH INFO -->
        <div class="card">
          <div class="pill"><span class="dot"></span><span id="statusText">‚Äî</span></div>

          <div class="kv">
            <span>Sp√•rningsnummer</span>
            <strong id="trackingValue">‚Äî</strong>
          </div>

          <div class="kv">
            <span>PostNord-nummer</span>
            <strong id="postnordValue">Inte tilldelat √§nnu</strong>
          </div>

          <div class="kv">
            <span>CityMail-nummer</span>
            <strong id="citymailValue">Inte tilldelat √§nnu</strong>
          </div>

          <div class="kv">
            <span>Senast uppdaterad</span>
            <strong id="updatedValue">‚Äî</strong>
          </div>

          <div class="links" id="linksWrap"></div>

          <div class="subnote" id="carrierNote" style="display:none;"></div>
        </div>

        <!-- RIGHT: ETA + PROGRESS -->
        <div class="card">
          <div class="etaTop">
            <div class="etaTitle">Ber√§knad leverans</div>
            <div class="badge" id="etaBadge">‚Äî</div>
          </div>

          <div class="etaBig" id="etaBig">‚Äî</div>
          <div class="etaSmall" id="etaSmall">Uppskattning baserad p√• senaste h√§ndelsen.</div>

          <div class="progressWrap">
            <div class="progressTitle">Leveransf√∂rlopp</div>
            <div class="barOuter">
              <div class="barInner" id="progressBar"></div>
            </div>
            <div class="barLabel" id="progressLabel">Registrerad</div>
          </div>
        </div>
      </div>

      <h3>H√§ndelser</h3>
      <div class="timeline" id="events"></div>
    </div>
  </div>

  <script>
    // Elements
    const tabTracking = document.getElementById("tabTracking");
    const tabOrder = document.getElementById("tabOrder");
    const trackForm = document.getElementById("trackForm");
    const orderForm = document.getElementById("orderForm");

    const trackingInput = document.getElementById("trackingInput");
    const orderInput = document.getElementById("orderInput");
    const emailInput = document.getElementById("emailInput");

    const trackBtn = document.getElementById("trackBtn");
    const orderBtn = document.getElementById("orderBtn");

    const errorBox = document.getElementById("errorBox");
    const resultArea = document.getElementById("resultArea");

    const statusText = document.getElementById("statusText");
    const trackingValue = document.getElementById("trackingValue");
    const postnordValue = document.getElementById("postnordValue");
    const citymailValue = document.getElementById("citymailValue");
    const updatedValue = document.getElementById("updatedValue");

    const linksWrap = document.getElementById("linksWrap");
    const carrierNote = document.getElementById("carrierNote");

    const etaBadge = document.getElementById("etaBadge");
    const etaBig = document.getElementById("etaBig");
    const etaSmall = document.getElementById("etaSmall");

    const progressBar = document.getElementById("progressBar");
    const progressLabel = document.getElementById("progressLabel");

    const eventsEl = document.getElementById("events");

    // Helpers
    function showError(msg){
      errorBox.textContent = msg;
      errorBox.style.display = "block";
      resultArea.classList.add("hidden");
    }
    function clearError(){
      errorBox.style.display = "none";
      errorBox.textContent = "";
    }
    function showResult(){
      resultArea.classList.remove("hidden");
    }

    function formatDate(dt){
      if(!dt) return "‚Äî";
      const d = new Date(dt);
      if(isNaN(d.getTime())) return dt;
      return d.toLocaleString("sv-SE");
    }

    function setProgress(milestone){
      let pct=25, label="Registrerad";
      const m = (milestone || "").toString().toLowerCase();
      if(m === "pending" || m === "info_received"){ pct=25; label="Registrerad"; }
      else if(m === "in_transit"){ pct=55; label="P√• v√§g"; }
      else if(m === "out_for_delivery"){ pct=80; label="Ute f√∂r leverans"; }
      else if(m === "available_for_pickup"){ pct=90; label="Klar f√∂r upph√§mtning"; }
      else if(m === "delivered"){ pct=100; label="Levererad"; }
      progressBar.style.width = pct + "%";
      progressLabel.textContent = label;
    }

    function updateUrlWithTn(tn){
      const url = new URL(window.location.href);
      url.searchParams.set("tn", tn);
      window.history.replaceState({}, "", url.toString());
    }

    function buildLinks(postnord, citymail){
      const parts = [];
      if(postnord){
        parts.push(`<a class="link" href="https://portal.postnord.com/tracking/details/${encodeURIComponent(postnord)}" target="_blank" rel="noopener noreferrer">üì¶ √ñppna i PostNord</a>`);
      }
      if(citymail){
        parts.push(`<a class="link" href="https://tracking.citymail.se/?search=${encodeURIComponent(citymail)}" target="_blank" rel="noopener noreferrer">üì´ √ñppna i CityMail</a>`);
      }
      if(parts.length === 0){
        return `<span style="color:#6b7280;font-size:13px;">N√§r lokalt sp√•rningsnummer skapas kan du √∂ppna det h√§r.</span>`;
      }
      return parts.join("");
    }

    function setCarrierNote(carrier){
      if(carrier === "postnord"){
        carrierNote.style.display = "block";
        carrierNote.textContent = "Transport√∂r: PostNord";
      } else if(carrier === "citymail"){
        carrierNote.style.display = "block";
        carrierNote.textContent = "Transport√∂r: CityMail";
      } else {
        carrierNote.style.display = "none";
        carrierNote.textContent = "";
      }
    }

    async function renderResult(data){
      // Left tech
      trackingValue.textContent = data.trackingNumber || "‚Äî";
      statusText.textContent = data.statusSwedish || data.statusMilestone || "‚Äî";
      updatedValue.textContent = formatDate(data.lastUpdate);

      postnordValue.textContent = data.postnordNumber || "Inte tilldelat √§nnu";
      citymailValue.textContent = data.citymailNumber || "Inte tilldelat √§nnu";

      linksWrap.innerHTML = buildLinks(data.postnordNumber, data.citymailNumber);
      setCarrierNote(data.carrierDetected);

      // Right ETA
      const etaText = data.estimated_delivery || "‚Äî";
      etaBig.textContent = etaText;
      etaSmall.textContent =
        data.eta_note_sv && String(data.eta_note_sv).trim()
          ? data.eta_note_sv
          : "Uppskattning baserad p√• senaste h√§ndelsen.";

      etaBadge.textContent =
        data.carrierDetected === "postnord" ? "PostNord" :
        data.carrierDetected === "citymail" ? "CityMail" :
        "‚Äî";

      // Progress
      setProgress(data.statusMilestone);

      // Events
      eventsEl.innerHTML = "";
      (data.events || []).forEach(ev => {
        const div = document.createElement("div");
        div.className = "event";
        div.innerHTML = `
          <div class="event-time">${formatDate(ev.datetime)}</div>
          <div class="event-status">${(ev.status || "-")}</div>
          <div class="event-location">${(ev.location || "")}</div>
        `;
        eventsEl.appendChild(div);
      });

      showResult();
    }

    async function trackByTrackingNumber(tn){
      const value = (tn || "").trim();
      if(!value) return;

      clearError();
      trackBtn.disabled = true;

      updateUrlWithTn(value);

      try{
        const res = await fetch(`/api/track?value=${encodeURIComponent(value)}&mode=tracking`);
        const data = await res.json();
        if(!data.ok) throw new Error(data.error || "Kunde inte hitta f√∂rs√§ndelsen.");
        await renderResult(data);
      }catch(err){
        showError(err.message || "N√•got gick fel.");
      }finally{
        trackBtn.disabled = false;
      }
    }

    async function trackByOrder(order, email){
      const o = (order || "").trim();
      const e = (email || "").trim();
      if(!o || !e) return;

      clearError();
      orderBtn.disabled = true;

      try{
        const res = await fetch(`/api/track-order?order=${encodeURIComponent(o)}&email=${encodeURIComponent(e)}`);
        const data = await res.json();
        if(!data.ok) throw new Error(data.error || "Kunde inte hitta ordern.");
        await renderResult(data);
      }catch(err){
        showError(err.message || "N√•got gick fel.");
      }finally{
        orderBtn.disabled = false;
      }
    }

    // Tabs
    tabTracking.addEventListener("click", () => {
      tabTracking.classList.add("active");
      tabOrder.classList.remove("active");
      trackForm.classList.remove("hidden");
      orderForm.classList.add("hidden");
    });

    tabOrder.addEventListener("click", () => {
      tabOrder.classList.add("active");
      tabTracking.classList.remove("active");
      orderForm.classList.remove("hidden");
      trackForm.classList.add("hidden");
    });

    // Submit handlers
    trackForm.addEventListener("submit", (e) => {
      e.preventDefault();
      trackByTrackingNumber(trackingInput.value);
    });

    orderForm.addEventListener("submit", (e) => {
      e.preventDefault();
      trackByOrder(orderInput.value, emailInput.value);
    });

    // Auto-run via ?tn=
    (function initFromQuery(){
      const url = new URL(window.location.href);
      const tn = url.searchParams.get("tn");
      if(tn){
        trackingInput.value = tn;
        trackByTrackingNumber(tn);
      }
    })();
  </script>

  <script>
    // EN -> SV √∂vers√§ttning f√∂r event-status (UI)
    (function () {
      const EN_TO_SV = [
        [/^Arrive in transit center$/i, "Ankom till transitcenter"],
        [/^Released from customs:\s*customs cleared\.$/i, "Tullklarerad"],
        [/^Arrival to the destination airport$/i, "Ankom till destinationsflygplats"],
        [/^Departure from the original airport$/i, "Avgick fr√•n ursprungsflygplats"],
        [/^Hand over to airline\.$/i, "√ñverl√§mnat till flygbolag"],
        [/^Shipping information received$/i, "Fraktinformation mottagen"],
        [/^Parcel information received$/i, "Paketinformation mottagen"],
        [/^Shipment arrived at facility and measured\.$/i, "Ankom till anl√§ggning och registrerades"],
        [/^Shipment picked up\.$/i, "H√§mtad av transport√∂r"],
        [/^Depart from facility to service provider\.$/i, "L√§mnade anl√§ggning f√∂r vidare transport"],
        [/^The shipment item is under transportation\.$/i, "F√∂rs√§ndelsen √§r under transport"],
        [/^The shipment item has arrived at the country of destination\.$/i, "Ankom till destinationslandet"],
        [/^The shipment item has been loaded\.$/i, "F√∂rs√§ndelsen har lastats"],
        [/^A text message notification has been sent to the recipient\.$/i, "SMS-notis har skickats till mottagaren"],
        [/^Parcel outbound from transit center\.$/i, "Paketet har l√§mnat transitcentret"],
        [/^The shipment item has been delivered at the recipient's door\.$/i, "Levererad till mottagarens d√∂rr"],
        [/^We have received a notification from your shipper.*$/i, "Avisering mottagen fr√•n avs√§ndaren ‚Äì uppdateras n√§r paketet hanteras av lokal transport√∂r"],
      ];

      function translateText(s) {
        if (!s) return s;
        const t = String(s).trim();
        for (const [re, sv] of EN_TO_SV) if (re.test(t)) return sv;
        return t;
      }

      function translateEvents() {
        const nodes = document.querySelectorAll(".event-status");
        nodes.forEach(node => {
          const text = (node.textContent || "").trim();
          if (!text) return;
          const translated = translateText(text);
          if (translated !== text) node.textContent = translated;
        });
      }

      translateEvents();
      const obs = new MutationObserver(() => translateEvents());
      obs.observe(document.body, { subtree: true, childList: true });
    })();
  </script>
</body>
</html>
