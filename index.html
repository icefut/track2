<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Sp√•ra din best√§llning</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:#f3f4f6;
      margin:0;
      padding:20px;
    }
    .container {
      max-width:900px;
      margin:0 auto;
      background:#fff;
      padding:24px;
      border-radius:12px;
      box-shadow:0 10px 25px rgba(0,0,0,0.05);
      border:1px solid #e5e7eb;
    }
    h1 { margin:0 0 10px; font-size:28px; }
    p { margin:0 0 16px; color:#4b5563; }

    /* Tabs */
    .tabs {
      display:flex;
      gap:6px;
      margin-bottom:16px;
      border-radius:999px;
      background:#e5e7eb;
      padding:4px;
    }
    .tab {
      flex:1;
      text-align:center;
      padding:10px 12px;
      font-size:14px;
      cursor:pointer;
      border-radius:999px;
      border:none;
      background:transparent;
      color:#111827;
      font-weight:700;
    }
    .tab.active {
      background:#2563eb;
      color:#fff;
      box-shadow:0 8px 18px rgba(37,99,235,.22);
    }

    .row {
      display:flex;
      gap:8px;
      margin-bottom:12px;
      flex-wrap:wrap;
      align-items:center;
    }
    input[type="text"], input[type="email"] {
      flex:1;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #d1d5db;
      font-size:14px;
      outline:none;
      min-width:240px;
      background:#fff;
    }
    input:focus {
      border-color:#2563eb;
      box-shadow:0 0 0 3px #2563eb22;
    }
    button.primary {
      padding:10px 16px;
      border-radius:10px;
      border:none;
      background:#2563eb;
      color:#fff;
      font-weight:800;
      cursor:pointer;
      white-space:nowrap;
      display:flex;
      align-items:center;
      gap:8px;
      box-shadow:0 10px 20px rgba(37,99,235,.18);
    }
    button.primary:disabled { opacity:.6; cursor:wait; }

    .smallhint{
      font-size:13px;
      color:#6b7280;
      margin-top:4px;
      margin-bottom:16px;
      line-height:1.35;
    }

    .status-grid{
      display:grid;
      grid-template-columns: 1.1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media (max-width:820px){
      .status-grid{ grid-template-columns:1fr; }
    }

    .status-box {
      padding:14px;
      background:#f9fafb;
      border-radius:12px;
      border:1px solid #e5e7eb;
      font-size:14px;
    }
    .status-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      font-weight:800;
      font-size:12px;
      background:#ecfdf5;
      border:1px solid #d1fae5;
      color:#065f46;
      margin-bottom:10px;
    }
    .dot{
      width:9px;height:9px;border-radius:999px;background:#22c55e;
      box-shadow:0 0 0 3px rgba(34,197,94,.15);
    }

    .kv {
      display:flex;
      justify-content:space-between;
      gap:12px;
      padding:8px 0;
      border-top:1px dashed #e5e7eb;
    }
    .kv:first-child{ border-top:none; padding-top:0; }
    .kv span { color:#6b7280; }
    .kv strong { font-weight:900; text-align:right; max-width:60%; word-break:break-word; }

    .subnote{
      margin-top:8px;
      color:#6b7280;
      font-size:12px;
      line-height:1.35;
    }

    .link {
      color:#2563eb;
      text-decoration:none;
      font-weight:800;
    }
    .link:hover { text-decoration:underline; }

    .timeline {
      margin-top:16px;
      border-left:2px solid #2563eb;
      padding-left:18px;
    }
    .event {
      margin-bottom:16px;
      position:relative;
    }
    .event::before {
      content:"";
      position:absolute;
      left:-20px;
      top:3px;
      width:10px;
      height:10px;
      border-radius:999px;
      background:#2563eb;
      border:2px solid #fff;
      box-shadow:0 0 0 2px #2563eb;
    }
    .event-time { font-size:13px; color:#6b7280; }
    .event-status { font-size:14px; font-weight:800; }
    .event-location { font-size:13px; color:#4b5563; }

    .error {
      margin-top:8px;
      padding:10px 12px;
      border-radius:12px;
      background:#fef2f2;
      color:#b91c1c;
      border:1px solid #fecaca;
      font-size:14px;
      display:none;
      font-weight:700;
    }

    .hidden { display:none; }
  </style>
</head>

<body>
  <div class="container">
    <h1>Sp√•ra din best√§llning</h1>
    <p>Sp√•ra med ditt 4PX-sp√•rningsnummer eller med ordernummer + e-post.</p>

    <div class="tabs">
      <button class="tab active" id="tabTracking" type="button">Sp√•rningsnummer</button>
      <button class="tab" id="tabOrder" type="button">Ordernummer + e-post</button>
    </div>

    <!-- TRACKING FORM -->
    <form id="trackForm">
      <div class="row">
        <input type="text" id="trackingInput" placeholder="T.ex. 4PX..., BC...CN" autocomplete="off" />
        <button type="submit" class="primary" id="trackBtn">üîé Sp√•ra</button>
      </div>
      <div class="smallhint">
        Tips: Efter s√∂kning uppdateras l√§nken automatiskt till <b>?tn=...</b> s√• du kan kopiera och skicka till kunden.
      </div>
    </form>

    <!-- ORDER FORM -->
    <form id="orderForm" class="hidden">
      <div class="row">
        <input type="text" id="orderInput" placeholder="Ordernummer, t.ex. 22700" autocomplete="off" />
        <input type="email" id="emailInput" placeholder="E-post som anv√§ndes vid best√§llning" autocomplete="off" />
        <button type="submit" class="primary" id="orderBtn">üîé Sp√•ra</button>
      </div>
      <div class="smallhint">
        Ange ditt ordernummer och samma e-postadress som du anv√§nde vid best√§llningen.
      </div>
    </form>

    <div id="errorBox" class="error"></div>

    <div id="resultArea" class="hidden">
      <div class="status-grid">
        <div class="status-box">
          <div class="status-pill"><span class="dot"></span><span id="statusText">‚Äî</span></div>

          <div class="kv">
            <span>Sp√•rningsnummer</span>
            <strong id="trackingValue">‚Äî</strong>
          </div>

          <div class="kv">
            <span>PostNord-nummer</span>
            <strong id="postnordValue">Inte tilldelat √§nnu</strong>
          </div>

          <div class="kv">
            <span>CityMail-nummer</span>
            <strong id="citymailValue">Inte tilldelat √§nnu</strong>
          </div>

          <!-- ‚úÖ NYTT: ETA -->
          <div class="kv">
            <span>Ber√§knad leverans</span>
            <strong id="estimatedValue">‚Äî</strong>
          </div>

          <div class="kv">
            <span>Senast uppdaterad</span>
            <strong id="updatedValue">‚Äî</strong>
          </div>

          <div id="linksWrap" style="margin-top:10px;"></div>

          <div class="subnote" id="etaNote" style="display:none;"></div>
          <div class="subnote" id="carrierNote" style="display:none;"></div>
        </div>

        <div class="status-box">
          <div style="font-weight:900; margin-bottom:8px;">Leveransf√∂rlopp</div>
          <div style="height:10px;border-radius:999px;background:#e5e7eb;overflow:hidden;border:1px solid #d1d5db;">
            <div id="progressBar" style="height:100%;width:25%;background:#2563eb;"></div>
          </div>
          <div id="progressLabel" style="margin-top:8px;color:#4b5563;font-weight:800;">Registrerad</div>
        </div>
      </div>

      <h3 style="margin-top:18px;">H√§ndelser</h3>
      <div id="events" class="timeline"></div>
    </div>
  </div>

  <script>
    const tabTracking = document.getElementById("tabTracking");
    const tabOrder = document.getElementById("tabOrder");
    const trackForm = document.getElementById("trackForm");
    const orderForm = document.getElementById("orderForm");

    const trackingInput = document.getElementById("trackingInput");
    const orderInput = document.getElementById("orderInput");
    const emailInput = document.getElementById("emailInput");

    const trackBtn = document.getElementById("trackBtn");
    const orderBtn = document.getElementById("orderBtn");

    const errorBox = document.getElementById("errorBox");
    const resultArea = document.getElementById("resultArea");

    const statusText = document.getElementById("statusText");
    const trackingValue = document.getElementById("trackingValue");
    const postnordValue = document.getElementById("postnordValue");
    const citymailValue = document.getElementById("citymailValue");
    const estimatedValue = document.getElementById("estimatedValue");
    const updatedValue = document.getElementById("updatedValue");
    const linksWrap = document.getElementById("linksWrap");

    const etaNote = document.getElementById("etaNote");
    const carrierNote = document.getElementById("carrierNote");

    const progressBar = document.getElementById("progressBar");
    const progressLabel = document.getElementById("progressLabel");

    const eventsEl = document.getElementById("events");

    function showError(msg){
      errorBox.textContent = msg;
      errorBox.style.display = "block";
      resultArea.classList.add("hidden");
    }
    function clearError(){
      errorBox.style.display = "none";
      errorBox.textContent = "";
    }
    function showResult(){
      resultArea.classList.remove("hidden");
    }

    function formatDate(dt){
      if(!dt) return "‚Äî";
      const d = new Date(dt);
      if(isNaN(d.getTime())) return dt;
      return d.toLocaleString("sv-SE");
    }

    function setProgress(milestone){
      let pct=25, label="Registrerad";
      const m = (milestone || "").toString().toLowerCase();
      if(m === "pending" || m === "info_received"){ pct=25; label="Registrerad"; }
      else if(m === "in_transit"){ pct=55; label="P√• v√§g"; }
      else if(m === "out_for_delivery"){ pct=80; label="Ute f√∂r leverans"; }
      else if(m === "available_for_pickup"){ pct=90; label="Klar f√∂r upph√§mtning"; }
      else if(m === "delivered"){ pct=100; label="Levererad"; }
      progressBar.style.width = pct + "%";
      progressLabel.textContent = label;
    }

    function updateUrlWithTn(tn){
      const url = new URL(window.location.href);
      url.searchParams.set("tn", tn);
      window.history.replaceState({}, "", url.toString());
    }

    function buildLinks(postnord, citymail){
      const parts = [];
      if(postnord){
        parts.push(`<a class="link" href="https://portal.postnord.com/tracking/details/${encodeURIComponent(postnord)}" target="_blank" rel="noopener noreferrer">√ñppna i PostNord</a>`);
      }
      if(citymail){
        parts.push(`<a class="link" href="https://tracking.citymail.se/?search=${encodeURIComponent(citymail)}" target="_blank" rel="noopener noreferrer">√ñppna i CityMail</a>`);
      }
      if(parts.length === 0){
        return `<span style="color:#6b7280;">N√§r lokalt sp√•rningsnummer skapas kan du √∂ppna det h√§r.</span>`;
      }
      return parts.join(" &nbsp;‚Ä¢&nbsp; ");
    }

    function showOptionalNote(el, text){
      if(text && String(text).trim()){
        el.textContent = text;
        el.style.display = "block";
      }else{
        el.textContent = "";
        el.style.display = "none";
      }
    }

    async function renderResult(data){
      trackingValue.textContent = data.trackingNumber || "‚Äî";
      statusText.textContent = data.statusSwedish || data.statusMilestone || "‚Äî";
      updatedValue.textContent = formatDate(data.lastUpdate);

      postnordValue.textContent = data.postnordNumber || "Inte tilldelat √§nnu";
      citymailValue.textContent = data.citymailNumber || "Inte tilldelat √§nnu";

      // ‚úÖ ETA fr√•n backend
      estimatedValue.textContent = data.estimated_delivery || "‚Äî";

      linksWrap.innerHTML = buildLinks(data.postnordNumber, data.citymailNumber);

      setProgress(data.statusMilestone);

      // Liten note-text (om backend skickar)
      showOptionalNote(etaNote, data.eta_note_sv || "");

      // Diskret carrier-info (bra f√∂r debugging / support)
      if (data.carrierDetected && data.carrierDetected !== "unknown") {
        const label = data.carrierDetected === "postnord" ? "PostNord" : "CityMail";
        showOptionalNote(carrierNote, `Transport√∂r: ${label}`);
      } else {
        showOptionalNote(carrierNote, "");
      }

      eventsEl.innerHTML = "";
      (data.events || []).forEach(ev => {
        const div = document.createElement("div");
        div.className = "event";
        div.innerHTML = `
          <div class="event-time">${formatDate(ev.datetime)}</div>
          <div class="event-status">${(ev.status || "-")}</div>
          <div class="event-location">${(ev.location || "")}</div>
        `;
        eventsEl.appendChild(div);
      });

      showResult();
    }

    async function trackByTrackingNumber(tn){
      const value = (tn || "").trim();
      if(!value) return;

      clearError();
      trackBtn.disabled = true;

      updateUrlWithTn(value);

      try{
        const res = await fetch(`/api/track?value=${encodeURIComponent(value)}&mode=tracking`);
        const data = await res.json();
        if(!data.ok) throw new Error(data.error || "Kunde inte hitta f√∂rs√§ndelsen.");
        await renderResult(data);
      }catch(err){
        showError(err.message || "N√•got gick fel.");
      }finally{
        trackBtn.disabled = false;
      }
    }

    async function trackByOrder(order, email){
      const o = (order || "").trim();
      const e = (email || "").trim();
      if(!o || !e) return;

      clearError();
      orderBtn.disabled = true;

      try{
        const res = await fetch(`/api/track-order?order=${encodeURIComponent(o)}&email=${encodeURIComponent(e)}`);
        const data = await res.json();
        if(!data.ok) throw new Error(data.error || "Kunde inte hitta ordern.");
        await renderResult(data);
      }catch(err){
        showError(err.message || "N√•got gick fel.");
      }finally{
        orderBtn.disabled = false;
      }
    }

    // Tabs
    tabTracking.addEventListener("click", () => {
      tabTracking.classList.add("active");
      tabOrder.classList.remove("active");
      trackForm.classList.remove("hidden");
      orderForm.classList.add("hidden");
    });

    tabOrder.addEventListener("click", () => {
      tabOrder.classList.add("active");
      tabTracking.classList.remove("active");
      orderForm.classList.remove("hidden");
      trackForm.classList.add("hidden");
    });

    // Submit handlers
    trackForm.addEventListener("submit", (e) => {
      e.preventDefault();
      trackByTrackingNumber(trackingInput.value);
    });

    orderForm.addEventListener("submit", (e) => {
      e.preventDefault();
      trackByOrder(orderInput.value, emailInput.value);
    });

    // Auto-run via ?tn=
    (function initFromQuery(){
      const url = new URL(window.location.href);
      const tn = url.searchParams.get("tn");
      if(tn){
        trackingInput.value = tn;
        trackByTrackingNumber(tn);
      }
    })();
  </script>

  <script>
    // √ñvers√§tter vanliga Ship24/transport-event fr√•n EN -> SV utan att r√∂ra funktionaliteten
    (function () {
      const EN_TO_SV = [
        [/^Arrive in transit center$/i, "Ankom till transitcenter"],
        [/^Released from customs:\s*customs cleared\.$/i, "Tullklarerad"],
        [/^Arrival to the destination airport$/i, "Ankom till destinationsflygplats"],
        [/^Departure from the original airport$/i, "Avgick fr√•n ursprungsflygplats"],
        [/^Hand over to airline\.$/i, "√ñverl√§mnat till flygbolag"],
        [/^Shipping information received$/i, "Fraktinformation mottagen"],
        [/^Parcel information received$/i, "Paketinformation mottagen"],
        [/^Shipment arrived at facility and measured\.$/i, "Ankom till anl√§ggning och registrerades"],
        [/^Shipment picked up\.$/i, "H√§mtad av transport√∂r"],
        [/^Depart from facility to service provider\.$/i, "L√§mnade anl√§ggning f√∂r vidare transport"],
        [/^The shipment item is under transportation\.$/i, "F√∂rs√§ndelsen √§r under transport"],
        [/^The shipment item has arrived at the country of destination\.$/i, "Ankom till destinationslandet"],
        [/^The shipment item has been loaded\.$/i, "F√∂rs√§ndelsen har lastats"],
        [/^A text message notification has been sent to the recipient\.$/i, "SMS-notis har skickats till mottagaren"],
        [/^Parcel outbound from transit center\.$/i, "Paketet har l√§mnat transitcentret"],
        [/^The shipment item has been delivered at the recipient's door\.$/i, "Levererad till mottagarens d√∂rr"],
        [/^We have received a notification from your shipper.*$/i, "Avisering mottagen fr√•n avs√§ndaren ‚Äì uppdateras n√§r paketet hanteras av lokal transport√∂r"],
      ];

      function translateText(s) {
        if (!s) return s;
        const t = String(s).trim();
        for (const [re, sv] of EN_TO_SV) {
          if (re.test(t)) return sv;
        }
        return t;
      }

      function translateEvents() {
        // Vi √∂vers√§tter bara statustext i event-listan (inte inputs/knappar)
        const nodes = document.querySelectorAll(".event-status");
        nodes.forEach(node => {
          const text = (node.textContent || "").trim();
          if (!text) return;
          const translated = translateText(text);
          if (translated !== text) node.textContent = translated;
        });
      }

      const run = () => translateEvents();
      run();

      const obs = new MutationObserver(() => run());
      obs.observe(document.body, { subtree: true, childList: true });
    })();
  </script>
</body>
</html>
