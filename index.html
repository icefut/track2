<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Sp√•ra din best√§llning ‚Äì Icefot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-page: #f3f4f6;
      --bg-card: #ffffff;
      --bg-input: #f9fafb;
      --bg-pill: #2563eb;
      --bg-pill-soft: #e5edff;
      --border-soft: #e5e7eb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --accent: #2563eb;
      --accent-soft: #eff6ff;
      --danger: #dc2626;
      --timeline-line: #d1d5db;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-page);
      margin: 0;
      padding: 24px 16px 40px;
      color: var(--text-main);
    }

    .page {
      max-width: 980px;
      margin: 0 auto;
    }

    h1 {
      font-size: 28px;
      margin: 0 0 4px;
      font-weight: 700;
    }

    .page-intro {
      margin-bottom: 20px;
      color: var(--text-muted);
      font-size: 14px;
    }

    .card {
      background: var(--bg-card);
      border-radius: 18px;
      padding: 20px 20px 22px;
      box-shadow:
        0 18px 45px rgba(15, 23, 42, 0.06),
        0 0 0 1px rgba(15, 23, 42, 0.02);
      margin-bottom: 18px;
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .card-icon {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: var(--accent-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--accent);
      font-size: 18px;
    }

    .card-title {
      font-weight: 600;
      font-size: 16px;
    }

    .card-subtitle {
      font-size: 13px;
      color: var(--text-muted);
    }

    /* Tabs (just en aktiv) */
    .tabs {
      display: flex;
      border-radius: 999px;
      background: #e5e7eb;
      padding: 4px;
      margin-bottom: 16px;
    }

    .tab {
      flex: 1;
      text-align: center;
      padding: 8px 12px;
      font-size: 13px;
      border-radius: 999px;
      border: none;
      cursor: default;
      background: var(--bg-pill);
      color: white;
      font-weight: 600;
    }

    /* Search row */
    .search-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 6px;
    }

    .search-input-wrapper {
      flex: 1;
      min-width: 220px;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: var(--bg-input);
      font-size: 14px;
      outline: none;
    }

    .search-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.15);
      background: #ffffff;
    }

    .search-input::placeholder {
      color: #9ca3af;
    }

    .primary-btn {
      padding: 10px 18px;
      border-radius: 10px;
      border: none;
      background: var(--accent);
      color: white;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .primary-btn:disabled {
      opacity: 0.7;
      cursor: wait;
    }

    .primary-btn span {
      font-size: 16px;
    }

    .hint {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .hint small {
      font-size: 11px;
      color: #9ca3af;
    }

    .error {
      margin-top: 8px;
      padding: 10px 12px;
      border-radius: 10px;
      background: #fef2f2;
      color: var(--danger);
      border: 1px solid #fecaca;
      font-size: 13px;
    }

    /* Result layout */
    #result {
      margin-top: 14px;
    }

    .status-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.4fr);
      gap: 14px;
    }

    @media (max-width: 720px) {
      .status-layout {
        grid-template-columns: 1fr;
      }
    }

    .status-box {
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      padding: 12px 14px;
      background: #fcfcfd;
      font-size: 13px;
    }

    .status-box-header {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      background: #ecfdf5;
      color: #15803d;
      margin-bottom: 8px;
    }

    .status-pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
    }

    .status-row {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 2px;
    }

    .status-label {
      color: var(--text-muted);
    }

    .status-value {
      font-weight: 500;
      text-align: right;
    }

    .status-small {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .link {
      color: var(--accent);
      text-decoration: none;
      font-weight: 500;
      font-size: 13px;
    }

    .link:hover {
      text-decoration: underline;
    }

    /* Progress bar */
    .progress-card {
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      padding: 12px 14px 14px;
      background: #fcfcfd;
      font-size: 13px;
    }

    .progress-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .progress-track {
      position: relative;
      height: 4px;
      border-radius: 999px;
      background: #e5e7eb;
      margin-bottom: 14px;
    }

    .progress-fill {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      border-radius: 999px;
      background: var(--accent);
      width: 0%;
      transition: width 0.25s ease-out;
    }

    .progress-steps {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-muted);
    }

    .progress-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      width: 25%;
      text-align: center;
    }

    .progress-dot {
      width: 12px;
      height: 12px;
      border-radius: 999px;
      border: 2px solid #d1d5db;
      background: #ffffff;
      box-shadow: 0 0 0 1px #e5e7eb;
    }

    .progress-step.active .progress-dot {
      border-color: var(--accent);
      background: var(--accent);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.18);
    }

    .progress-step.done .progress-dot {
      border-color: var(--accent);
      background: #ffffff;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
    }

    .progress-step-label {
      max-width: 80px;
    }

    /* Events */
    .events-header-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 6px;
    }

    .events-header-row small {
      font-size: 11px;
      color: var(--text-muted);
    }

    .timeline {
      border-left: 2px solid var(--timeline-line);
      padding-left: 18px;
    }

    .event {
      position: relative;
      margin-bottom: 14px;
      padding-left: 0;
    }

    .event::before {
      content: "";
      position: absolute;
      left: -20px;
      top: 4px;
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--timeline-line);
      border: 2px solid #ffffff;
      box-shadow: 0 0 0 2px var(--timeline-line);
    }

    .event.latest::before {
      background: var(--accent);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.3);
    }

    .event-inner {
      padding: 4px 8px;
      border-radius: 10px;
    }

    .event.latest .event-inner {
      background: #f3f8ff;
    }

    .event-time {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .event-status {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 2px;
    }

    .event-location {
      font-size: 12px;
      color: var(--text-muted);
    }

    .empty-state {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 4px;
    }
  </style>

    <div class="card">
      <div class="card-header">
        <div class="card-icon">üì¶</div>
        <div>
          <div class="card-title">Sp√•ra din best√§llning</div>
          <div class="card-subtitle">
            Ange ditt 4PX-sp√•rningsnummer f√∂r att f√∂lja paketet hela v√§gen hem.
          </div>
        </div>
      </div>

      <div class="tabs">
  <button class="tab tab-active" type="button" data-tab="tracking">
    Sp√•rningsnummer
  </button>
  <button class="tab" type="button" data-tab="order">
    Ordernummer + e-post
  </button>
</div>

      <form id="track-form">
        <div class="search-row">
          <div class="search-input-wrapper">
            <input
              id="input"
              class="search-input"
              type="text"
              placeholder="Till exempel 4PX3002‚Ä¶CN"
              autocomplete="off"
            />
          </div>
          <button type="submit" class="primary-btn" id="submit-btn">
            <span>üîç</span> Sp√•ra
          </button>
        </div>
        <div class="hint">
          Skriv in ditt 4PX-nummer exakt som i mailet.
          <br /><small>Om du nyligen f√•tt sp√•rnumret kan det dr√∂ja lite innan f√∂rsta h√§ndelsen syns.</small>
        </div>
      </form>

      <div id="error" class="error" style="display: none;"></div>

      <div id="result" style="display:none;">
        <div class="status-layout">
          <div class="status-box">
            <div class="status-box-header">Status</div>
            <div class="status-pill" id="status-pill">
              <span class="status-pill-dot"></span>
              <span id="res-status-pill-text">‚Äì</span>
            </div>

            <div class="status-row">
              <div class="status-label">Sp√•rningsnummer</div>
              <div class="status-value" id="res-tn">‚Äì</div>
            </div>
            <div class="status-row">
              <div class="status-label">PostNord-nummer</div>
              <div class="status-value" id="res-postnord">Inte tilldelat √§nnu</div>
            </div>
            <div class="status-small" id="res-updated">Senast uppdaterad: ‚Äì</div>

            <div class="status-small" id="res-postnord-link" style="margin-top:6px;"></div>
          </div>

          <div class="progress-card">
            <div class="progress-title">Leveransf√∂rlopp</div>
            <div class="progress-track">
              <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="progress-steps">
              <div class="progress-step" data-step="1">
                <div class="progress-dot"></div>
                <div class="progress-step-label">Registrerad</div>
              </div>
              <div class="progress-step" data-step="2">
                <div class="progress-dot"></div>
                <div class="progress-step-label">P√• v√§g</div>
              </div>
              <div class="progress-step" data-step="3">
                <div class="progress-dot"></div>
                <div class="progress-step-label">Ute f√∂r leverans</div>
              </div>
              <div class="progress-step" data-step="4">
                <div class="progress-dot"></div>
                <div class="progress-step-label">Levererad</div>
              </div>
            </div>
          </div>
        </div>

        <h3 style="margin:18px 0 6px; font-size:15px;">H√§ndelser</h3>
        <div class="events-header-row">
          <small>Senaste h√§ndelsen markeras med bl√• pricka.</small>
          <small>Senaste uppdateringar fr√•n fraktbolaget.</small>
        </div>
        <div id="events" class="timeline"></div>
      </div>

      <div id="empty-state" class="empty-state" style="margin-top:10px;">
        Skriv in ditt sp√•rningsnummer ovan f√∂r att se status p√• din best√§llning.
      </div>
    </div>
  </div>

  <script>
    const input = document.getElementById("input");
    const form = document.getElementById("track-form");
    const btn = document.getElementById("submit-btn");
    const errorBox = document.getElementById("error");
    const resultBox = document.getElementById("result");
    const emptyState = document.getElementById("empty-state");

    const tnSpan = document.getElementById("res-tn");
    const statusPillText = document.getElementById("res-status-pill-text");
    const postnordSpan = document.getElementById("res-postnord");
    const updatedSpan = document.getElementById("res-updated");
    const postnordLinkBox = document.getElementById("res-postnord-link");
    const progressFill = document.getElementById("progress-fill");
    const progressSteps = document.querySelectorAll(".progress-step");
    const eventsEl = document.getElementById("events");

    function formatDateTime(dt) {
      if (!dt) return "";
      const d = new Date(dt);
      if (isNaN(d.getTime())) return dt;
      // 30 nov 2025, 09:40
      return new Intl.DateTimeFormat("sv-SE", {
        day: "2-digit",
        month: "short",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit"
      }).format(d).replace(".", "");
    }

    // F√∂rs√∂k √∂vers√§tta Ship24-eventtexter till svenska
    function translateEventStatus(status) {
      if (!status) return "";
      const s = status.toLowerCase();

      if (
        s.includes("delivered to the recipient's mailbox") ||
        s.includes("delivered to the recipients mailbox")
      ) {
        return "F√∂rs√§ndelsen har levererats till mottagarens brevl√•da.";
      }
      if (s.includes("has been loaded")) {
        return "F√∂rs√§ndelsen har lastats.";
      }
      if (s.includes("is being processed at our sorting center")) {
        return "F√∂rs√§ndelsen hanteras p√• v√•r sorteringsterminal.";
      }
      if (s.includes("is under transportation")) {
        return "F√∂rs√§ndelsen √§r under transport.";
      }
      if (
        s.includes(
          "has been handed over to a partner for transportation to the final destination"
        )
      ) {
        return "F√∂rs√§ndelsen har √∂verl√§mnats till en partner f√∂r vidare transport till slutdestinationen.";
      }
      if (s.includes("shipping information received")) {
        return "Fraktinformation har mottagits.";
      }
      if (s.includes("parcel information received")) {
        return "Paketinformation har mottagits.";
      }
      if (s.includes("we have received a notification from your shipper")) {
        return "Vi har f√•tt information fr√•n avs√§ndaren om att en f√∂rs√§ndelse f√∂rbereds √•t dig.";
      }
      if (s.includes("shipment picked up")) {
        return "F√∂rs√§ndelsen har h√§mtats upp.";
      }
      if (s.includes("shipment arrived at facility and measured")) {
        return "F√∂rs√§ndelsen har ankommit till terminal och hanteras.";
      }
      if (s.includes("depart from facility to service provider")) {
        return "F√∂rs√§ndelsen har l√§mnat terminalen f√∂r vidare transport.";
      }
      if (s.includes("arrival to the destination airport")) {
        return "F√∂rs√§ndelsen har ankommit till destinationsflygplats.";
      }
      if (s.includes("departure from the original airport")) {
        return "F√∂rs√§ndelsen har l√§mnat ursprungsflygplatsen.";
      }
      if (s.includes("released from customs: customs cleared")) {
        return "F√∂rs√§ndelsen har klarerats i tullen.";
      }
      if (s.includes("arrive in transit center")) {
        return "F√∂rs√§ndelsen har ankommit till omlastningscentral.";
      }
      if (s.includes("parcel outbound from transit center")) {
        return "F√∂rs√§ndelsen har l√§mnat omlastningscentral.";
      }

      // Om vi inte k√§nner igen texten: visa originalet
      return "";
    }

    function mapMilestoneToStep(m) {
      if (!m) return 1;
      const s = m.toLowerCase();
      if (s === "delivered") return 4;
      if (s === "out_for_delivery") return 3;
      if (s === "in_transit" || s === "customs" || s === "exception") return 2;
      // info_received, pending, etc.
      return 1;
    }

    function updateProgress(milestone) {
      const step = mapMilestoneToStep(milestone);
      const stepPercent = [0, 0, 33, 66, 100][step] ?? 0;
      progressFill.style.width = stepPercent + "%";

      progressSteps.forEach((el) => {
        const s = Number(el.dataset.step);
        el.classList.remove("active", "done");
        if (s < step) el.classList.add("done");
        if (s === step) el.classList.add("active");
      });
    }

    async function fetchTracking(value) {
      const url = `/api/track?value=${encodeURIComponent(value)}&mode=tracking`;
      const res = await fetch(url);
      const data = await res.json();
      if (!data.ok) {
        throw new Error(
          data.error || "Kunde inte hitta n√•gon f√∂rs√§ndelse. Kontrollera numret."
        );
      }
      return data;
    }

    function renderResult(data) {
      // huvudinfo
      tnSpan.textContent = data.trackingNumber || "‚Äì";
      const statusText = data.statusSwedish || data.statusMilestone || "Ok√§nd status";
      statusPillText.textContent = statusText;

      postnordSpan.textContent =
        data.postnordNumber || "Inte tilldelat √§nnu";

      if (data.lastUpdate) {
        updatedSpan.textContent = "Senast uppdaterad: " + formatDateTime(data.lastUpdate);
      } else {
        updatedSpan.textContent = "Senast uppdaterad: ‚Äì";
      }

      if (data.postnordNumber) {
        postnordLinkBox.innerHTML = `
          <a class="link" href="https://portal.postnord.com/tracking/details/${encodeURIComponent(
            data.postnordNumber
          )}" target="_blank" rel="noopener noreferrer">
            √ñppna i PostNord
          </a>`;
      } else {
        postnordLinkBox.textContent =
          "N√§r PostNord-sp√•rningsnumret har skapats kan du sp√•ra vidare i PostNords app.";
      }

      updateProgress(data.statusMilestone);

      // H√§ndelser
      eventsEl.innerHTML = "";
      const events = data.events || [];

      if (!events.length) {
        eventsEl.innerHTML =
          '<div class="empty-state" style="margin-top:4px;">Inga h√§ndelser registrerade √§nnu. Prova igen senare.</div>';
      } else {
        events.forEach((ev, idx) => {
          const original = ev.status || "";
          const translated = translateEventStatus(original);
          const text = translated || original || "Status uppdaterad";

          const div = document.createElement("div");
          div.className = "event" + (idx === 0 ? " latest" : "");

          div.innerHTML = `
            <div class="event-inner">
              <div class="event-time">${formatDateTime(ev.datetime)}</div>
              <div class="event-status">${text}</div>
              <div class="event-location">${ev.location || ""}</div>
            </div>
          `;
          eventsEl.appendChild(div);
        });
      }

      resultBox.style.display = "block";
      emptyState.style.display = "none";
    }

    async function handleSearch(value, pushToUrl = true) {
      if (!value) return;

      errorBox.style.display = "none";
      resultBox.style.display = "none";

      btn.disabled = true;
      try {
        const normalized = await fetchTracking(value);
        renderResult(normalized);

        if (pushToUrl) {
          const url = new URL(window.location.href);
          url.searchParams.set("tn", value);
          history.replaceState(null, "", url.toString());
        }
      } catch (err) {
        resultBox.style.display = "none";
        emptyState.style.display = "none";
        errorBox.textContent = err.message || "N√•got gick fel.";
        errorBox.style.display = "block";
      } finally {
        btn.disabled = false;
      }
    }

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const value = input.value.trim();
      handleSearch(value, true);
    });

    // L√§s ev. tn fr√•n URL och s√∂k direkt
    (function initFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const tn = params.get("tn");
      if (tn) {
        input.value = tn;
        handleSearch(tn, false);
      }
    })();
  </script>
</body>
</html>
