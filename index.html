<!doctype html>
<html lang="sv">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sp√•ra din best√§llning</title>

    <style>
      :root {
        --bg: #f4f6f9;
        --card: #ffffff;
        --text: #0f172a;
        --muted: #64748b;
        --border: #e5e7eb;
        --blue: #1d4ed8;
        --blue2: #2563eb;
        --green: #16a34a;
        --shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
        --radius: 18px;
      }

      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        background: var(--bg);
        color: var(--text);
      }

      .wrap {
        max-width: 980px;
        margin: 40px auto;
        padding: 0 16px 60px;
      }

      .page-title {
        font-size: 34px;
        letter-spacing: -0.02em;
        margin: 10px 0 8px;
      }
      .page-subtitle {
        margin: 0 0 22px;
        color: var(--muted);
        line-height: 1.4;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
      }

      .hero {
        padding: 18px;
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 14px;
      }
      .hero-icon {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        background: #eef2ff;
        display: grid;
        place-items: center;
        border: 1px solid #e0e7ff;
        flex: 0 0 auto;
      }
      .hero h2 {
        font-size: 18px;
        margin: 0;
      }
      .hero p {
        margin: 2px 0 0;
        color: var(--muted);
        font-size: 13px;
      }

      .tabs {
        display: grid;
        grid-template-columns: 1fr 1fr;
        background: #eef2ff;
        border: 1px solid #dbeafe;
        border-radius: 999px;
        overflow: hidden;
        margin: 0 18px 14px;
      }
      .tab {
        padding: 12px 14px;
        font-weight: 700;
        text-align: center;
        cursor: pointer;
        user-select: none;
        color: #1e3a8a;
        font-size: 14px;
      }
      .tab.active {
        background: linear-gradient(180deg, var(--blue2), var(--blue));
        color: white;
      }

      .form-area {
        padding: 0 18px 18px;
      }

      .row {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 12px;
        align-items: center;
      }

      .row.two {
        grid-template-columns: 1fr 1fr auto;
      }

      label {
        display: block;
        font-size: 12px;
        color: var(--muted);
        margin: 8px 0 6px;
      }

      input {
        width: 100%;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px 12px;
        font-size: 15px;
        outline: none;
        background: #fff;
      }
      input:focus {
        border-color: #93c5fd;
        box-shadow: 0 0 0 4px rgba(59,130,246,0.12);
      }

      .btn {
        border: 0;
        border-radius: 12px;
        padding: 12px 16px;
        font-weight: 800;
        cursor: pointer;
        background: linear-gradient(180deg, var(--blue2), var(--blue));
        color: #fff;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
      }
      .btn:active { transform: translateY(1px); }

      .tip {
        margin-top: 10px;
        color: var(--muted);
        font-size: 13px;
      }

      .results {
        margin-top: 16px;
        padding: 18px;
      }

      .grid2 {
        display: grid;
        grid-template-columns: 1.1fr 1fr;
        gap: 14px;
      }
      @media (max-width: 840px) {
        .grid2 { grid-template-columns: 1fr; }
        .tabs { grid-template-columns: 1fr; border-radius: 18px; }
        .row { grid-template-columns: 1fr; }
        .row.two { grid-template-columns: 1fr; }
        .btn { width: 100%; justify-content: center; }
      }

      .panel {
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 14px;
        background: #fff;
      }

      .status-top {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 10px;
        margin-bottom: 10px;
      }
      .status-title {
        font-weight: 900;
        letter-spacing: 0.02em;
        font-size: 12px;
        color: var(--muted);
      }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-weight: 800;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: #f8fafc;
      }
      .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #94a3b8;
      }
      .dot.ok { background: var(--green); }
      .dot.blue { background: var(--blue); }

      .kv {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        padding: 8px 0;
        border-top: 1px dashed #e5e7eb;
      }
      .kv:first-of-type { border-top: 0; }
      .k { color: var(--muted); font-size: 13px; }
      .v { font-weight: 800; font-size: 13px; }

      .links {
        margin-top: 10px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .linkbtn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: #fff;
        color: var(--blue);
        text-decoration: none;
        font-weight: 800;
        font-size: 13px;
      }

      /* Progress (Leveransf√∂rlopp) */
      .progress-title {
        font-weight: 900;
        letter-spacing: 0.02em;
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 10px;
      }

      .progress-rail {
        position: relative;
        padding-top: 6px;
      }
      .rail {
        height: 6px;
        background: #e5e7eb;
        border-radius: 999px;
        overflow: hidden;
      }
      .rail-fill {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, var(--blue2), var(--blue));
        border-radius: 999px;
        transition: width 250ms ease;
      }

      .steps {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        margin-top: 14px;
      }
      .step {
        display: grid;
        justify-items: center;
        gap: 6px;
        text-align: center;
      }
      .circle {
        width: 16px;
        height: 16px;
        border-radius: 999px;
        border: 2px solid #cbd5e1;
        background: #fff;
      }
      .step.done .circle {
        border-color: var(--blue);
        background: var(--blue);
      }
      .step.active .circle {
        border-color: var(--blue);
        background: #fff;
        box-shadow: 0 0 0 5px rgba(59,130,246,0.14);
      }
      .step label {
        margin: 0;
        font-size: 12px;
        color: var(--muted);
      }
      .step.done label { color: #1e3a8a; font-weight: 800; }
      .step.active label { color: #1e3a8a; font-weight: 900; }

      /* Events */
      .events {
        margin-top: 14px;
        padding: 16px 18px;
      }
      .events-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
      }
      .events h3 {
        margin: 0;
        font-size: 18px;
      }
      .events small {
        color: var(--muted);
      }
      .timeline {
        margin-top: 10px;
        border-left: 3px solid #c7d2fe;
        padding-left: 14px;
      }
      .event {
        position: relative;
        padding: 10px 0 10px 0;
      }
      .event::before {
        content: "";
        position: absolute;
        left: -23px;
        top: 14px;
        width: 12px;
        height: 12px;
        border-radius: 999px;
        background: var(--blue);
        box-shadow: 0 0 0 4px rgba(59,130,246,0.15);
      }
      .event .dt {
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 2px;
      }
      .event .st {
        font-weight: 900;
      }
      .event .loc {
        color: var(--muted);
        font-size: 13px;
        margin-top: 2px;
      }

      .hidden { display: none !important; }

      .error {
        margin-top: 10px;
        padding: 12px 12px;
        border-radius: 12px;
        background: #fef2f2;
        border: 1px solid #fecaca;
        color: #991b1b;
        font-weight: 700;
        display: none;
      }

      .loading {
        display: none;
        margin-top: 10px;
        color: var(--muted);
        font-weight: 700;
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <h1 class="page-title">Sp√•ra ditt paket</h1>
      <p class="page-subtitle">
        Skriv in ditt sp√•rningsnummer f√∂r att se status. Du kan ocks√• √∂ppna en direktl√§nk med <strong>?tn=</strong> i URL:en.
      </p>

      <div class="card">
        <div class="hero">
          <div class="hero-icon">üì¶</div>
          <div>
            <h2>Sp√•ra din best√§llning</h2>
            <p>Sp√•ra med ditt sp√•rningsnummer eller med ordernummer + e-postadress.</p>
          </div>
        </div>

        <div class="tabs" role="tablist" aria-label="Sp√•rningsmetod">
          <div id="tabTracking" class="tab active" role="tab" aria-selected="true">Sp√•rningsnummer</div>
          <div id="tabOrder" class="tab" role="tab" aria-selected="false">Ordernummer + e-post</div>
        </div>

        <div class="form-area">
          <!-- Tracking tab -->
          <div id="panelTracking">
            <div class="row">
              <div>
                <label for="trackingInput">Sp√•rningsnummer</label>
                <input id="trackingInput" type="text" placeholder="T.ex. 4PX..., BC...CN" />
              </div>
              <button id="trackBtn" class="btn" type="button">üîé Sp√•ra</button>
            </div>
            <div class="tip">
              Tips: Om du vill skicka en l√§nk till kunden, kopiera adressen efter s√∂kning (den blir automatiskt <strong>?tn=...</strong>).
            </div>
          </div>

          <!-- Order tab -->
          <div id="panelOrder" class="hidden">
            <div class="row two">
              <div>
                <label for="orderInput">Ordernummer</label>
                <input id="orderInput" type="text" placeholder="T.ex. 22700" />
              </div>
              <div>
                <label for="emailInput">E-post</label>
                <input id="emailInput" type="email" placeholder="Samma e-post som vid best√§llningen" />
              </div>
              <button id="trackOrderBtn" class="btn" type="button">üîé Sp√•ra</button>
            </div>
            <div class="tip">
              Ange ditt ordernummer och samma e-postadress som du anv√§nde vid best√§llningen.
            </div>
          </div>

          <div id="loading" class="loading">H√§mtar sp√•rning...</div>
          <div id="errorBox" class="error"></div>
        </div>

        <!-- Results -->
        <div id="results" class="results hidden">
          <div class="grid2">
            <!-- STATUS -->
            <div class="panel">
              <div class="status-top">
                <div>
                  <div class="status-title">STATUS</div>
                  <div style="margin-top:6px; font-size:18px; font-weight:900;" id="statusHeadline">‚Äî</div>
                </div>

                <div class="badge">
                  <span class="dot ok" id="statusDot"></span>
                  <span id="statusBadgeText">‚Äî</span>
                </div>
              </div>

              <div class="kv">
                <div class="k">Sp√•rningsnummer</div>
                <div class="v" id="trackingNumberValue">‚Äî</div>
              </div>
              <div class="kv">
                <div class="k">PostNord-nummer</div>
                <div class="v" id="postnordValue">Inte tilldelat √§nnu</div>
              </div>
              <div class="kv">
                <div class="k">CityMail-nummer</div>
                <div class="v" id="citymailValue">Inte tilldelat √§nnu</div>
              </div>
              <div class="kv">
                <div class="k">Senast uppdaterad</div>
                <div class="v" id="lastUpdateValue">‚Äî</div>
              </div>

              <div class="links">
                <a id="postnordLink" class="linkbtn hidden" target="_blank" rel="noopener">üì≤ √ñppna i PostNord</a>
                <a id="citymailLink" class="linkbtn hidden" target="_blank" rel="noopener">üìÆ √ñppna i CityMail</a>
              </div>

              <div class="tip" id="localHint">
                N√§r lokalt sp√•rningsnummer skapas kan du √∂ppna det h√§r.
              </div>
            </div>

            <!-- LEVERANSF√ñRLOPP -->
            <div class="panel">
              <div class="progress-title">LEVERANSF√ñRLOPP</div>

              <div class="progress-rail">
                <div class="rail">
                  <div id="railFill" class="rail-fill"></div>
                </div>

                <div class="steps" id="steps">
                  <div class="step" data-step="0">
                    <div class="circle"></div>
                    <label>Registrerad</label>
                  </div>
                  <div class="step" data-step="1">
                    <div class="circle"></div>
                    <label>P√• v√§g</label>
                  </div>
                  <div class="step" data-step="2">
                    <div class="circle"></div>
                    <label>Ute f√∂r leverans</label>
                  </div>
                  <div class="step" data-step="3">
                    <div class="circle"></div>
                    <label>Levererad</label>
                  </div>
                </div>

                <div style="margin-top:12px; font-weight:900;" id="progressHeadline">‚Äî</div>
              </div>
            </div>
          </div>

          <!-- EVENTS -->
          <div class="events">
            <div class="events-head">
              <h3>H√§ndelser</h3>
              <small>Senaste uppdateringar fr√•n fraktbolaget.</small>
            </div>
            <div id="eventsList" class="timeline"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Beh√•ll din befintliga logik i track.js -->
    <script src="./track.js"></script>

    <!-- UI + Svenskifiering (utan att du beh√∂ver r√∂ra track.js) -->
    <script>
      // Tabs
      const tabTracking = document.getElementById("tabTracking");
      const tabOrder = document.getElementById("tabOrder");
      const panelTracking = document.getElementById("panelTracking");
      const panelOrder = document.getElementById("panelOrder");

      function setTab(which) {
        const isTracking = which === "tracking";
        tabTracking.classList.toggle("active", isTracking);
        tabOrder.classList.toggle("active", !isTracking);
        tabTracking.setAttribute("aria-selected", isTracking ? "true" : "false");
        tabOrder.setAttribute("aria-selected", !isTracking ? "true" : "false");
        panelTracking.classList.toggle("hidden", !isTracking);
        panelOrder.classList.toggle("hidden", isTracking);
      }

      tabTracking.addEventListener("click", () => setTab("tracking"));
      tabOrder.addEventListener("click", () => setTab("order"));

      // ===== Svenskifiera h√§ndelsetexter (Ship24 kan ge engelska statusrader) =====
      const EN_TO_SV = [
        [/^arrive in transit center$/i, "Ankom till transitcenter"],
        [/^released from customs: customs cleared\.$/i, "Tullklarerad"],
        [/^arrival to the destination airport$/i, "Ankom till destinationsflygplats"],
        [/^departure from the original airport$/i, "Avgick fr√•n ursprungsflygplats"],
        [/^hand over to airline\.$/i, "√ñverl√§mnat till flygbolag"],
        [/^shipping information received$/i, "Fraktinformation mottagen"],
        [/^parcel information received$/i, "Paketinformation mottagen"],
        [/^shipment arrived at facility and measured\.$/i, "Ankom till anl√§ggning och registrerades"],
        [/^shipment picked up\.$/i, "H√§mtad av transport√∂r"],
        [/^depart from facility to service provider\.$/i, "L√§mnade anl√§ggning f√∂r vidare transport"],
        [/^the shipment item is under transportation\.$/i, "F√∂rs√§ndelsen √§r under transport"],
        [/^the shipment item has arrived at the country of destination\.$/i, "Ankom till destinationslandet"],
        [/^the shipment item has been loaded\.$/i, "F√∂rs√§ndelsen har lastats"],
        [/^a text message notification has been sent to the recipient\.$/i, "SMS-notis har skickats till mottagaren"],
        [/^the shipment item has been delivered at the recipient's door\.$/i, "Levererad till mottagarens d√∂rr"],
        [/^we have received a notification from your shipper.*$/i, "Avisering mottagen fr√•n avs√§ndaren ‚Äì uppdateras n√§r paketet hanteras av lokal transport√∂r"],
      ];

      function translateLine(text) {
        if (!text) return text;
        const t = text.trim();
        for (const [re, sv] of EN_TO_SV) {
          if (re.test(t)) return sv;
        }
        return t; // annars beh√•ll
      }

      // ===== Leveransf√∂rlopp: styrs av statusMilestone som track.js redan s√§tter i UI =====
      // Vi l√§ser av "statusBadgeText" / "statusHeadline" efter uppdatering och s√§tter progress.
      function milestoneToStep(milestoneText) {
        const m = (milestoneText || "").toLowerCase();

        // matcha b√•de svenska och ev. milestone-nycklar
        if (m.includes("levererad") || m.includes("delivered")) return 3;
        if (m.includes("ute f√∂r leverans") || m.includes("out_for_delivery")) return 2;
        if (m.includes("p√• v√§g") || m.includes("in_transit")) return 1;
        if (m.includes("registr") || m.includes("info_received")) return 0;

        // "pending"/ingen info -> visa som registrerad
        if (m.includes("ingen sp√•rningsinformation") || m.includes("pending")) return 0;

        return 0;
      }

      function applyProgressFromUI() {
        const statusText = document.getElementById("statusBadgeText")?.textContent || "";
        const step = milestoneToStep(statusText);

        const stepsEl = document.getElementById("steps");
        const fill = document.getElementById("railFill");
        const headline = document.getElementById("progressHeadline");

        const steps = Array.from(stepsEl.querySelectorAll(".step"));
        steps.forEach((el) => {
          const s = Number(el.dataset.step);
          el.classList.toggle("done", s < step);
          el.classList.toggle("active", s === step);
        });

        const pct = [8, 40, 70, 100][step] || 8;
        fill.style.width = pct + "%";

        const titles = ["Registrerad", "P√• v√§g", "Ute f√∂r leverans", "Levererad"];
        headline.textContent = titles[step] || "‚Äî";
      }

      // ===== √ñvers√§tt h√§ndelser efter att track.js renderat dem =====
      function translateEventsInDOM() {
        const list = document.getElementById("eventsList");
        if (!list) return;

        // F√∂rv√§ntat: track.js bygger DOM-noder, vi g√∂r bara ‚Äúpost-process‚Äù
        list.querySelectorAll(".event .st").forEach((node) => {
          node.textContent = translateLine(node.textContent);
        });
      }

      // Observera √§ndringar i results/events s√• vi kan ‚Äúfixa‚Äù UI efter track.js
      const results = document.getElementById("results");
      const obs = new MutationObserver(() => {
        if (!results.classList.contains("hidden")) {
          translateEventsInDOM();
          applyProgressFromUI();

          // Visa CityMail-l√§nk om citymailValue √§r ett riktigt nummer (BC...CN)
          const city = document.getElementById("citymailValue")?.textContent?.trim() || "";
          const cityLink = document.getElementById("citymailLink");
          if (cityLink) {
            const isCity = /^BC.+CN$/i.test(city);
            if (isCity) {
              cityLink.href = "https://tracking.citymail.se/?search=" + encodeURIComponent(city);
              cityLink.classList.remove("hidden");
            }
          }
        }
      });

      obs.observe(document.body, { childList: true, subtree: true });

      // K√∂r en g√•ng vid load
      window.addEventListener("load", () => {
        applyProgressFromUI();
        translateEventsInDOM();
      });
    </script>
  </body>
</html>
