<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Spåra din beställning</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:#f3f4f6;
      margin:0;
      padding:20px;
    }
    .container {
      max-width:900px;
      margin:0 auto;
      background:#fff;
      padding:24px;
      border-radius:12px;
      box-shadow:0 10px 25px rgba(0,0,0,0.05);
    }
    h1 {
      margin:0 0 12px;
      font-size:28px;
    }
    p {
      margin:0 0 16px;
      color:#4b5563;
    }

    /* "Tabs"-bar, men nu bara en knapp som ser likadan ut */
    .tabs {
      display:flex;
      margin-bottom:16px;
      border-radius:999px;
      background:#e5e7eb;
      padding:4px;
    }
    .tab {
      flex:1;
      text-align:center;
      padding:8px 12px;
      font-size:14px;
      cursor:default;
      border-radius:999px;
      border:none;
      background:#2563eb;
      color:#fff;
      font-weight:600;
    }

    .row {
      display:flex;
      gap:8px;
      margin-bottom:16px;
      flex-wrap:wrap;
    }
    input[type="text"] {
      flex:1;
      padding:10px 12px;
      border-radius:8px;
      border:1px solid #d1d5db;
      font-size:14px;
      outline:none;
    }
    input[type="text"]:focus {
      border-color:#2563eb;
      box-shadow:0 0 0 1px #2563eb33;
    }
    button.primary {
      padding:10px 16px;
      border-radius:8px;
      border:none;
      background:#2563eb;
      color:#fff;
      font-weight:600;
      cursor:pointer;
      white-space:nowrap;
    }
    button.primary:disabled {
      opacity:.6;
      cursor:wait;
    }
    .status-box {
      margin-top:8px;
      padding:12px;
      background:#f9fafb;
      border-radius:8px;
      border:1px solid #e5e7eb;
      font-size:14px;
    }
    .link {
      color:#2563eb;
      text-decoration:none;
      font-weight:500;
    }
    .timeline {
      margin-top:16px;
      border-left:2px solid #2563eb;
      padding-left:18px;
    }
    .event {
      margin-bottom:16px;
      position:relative;
    }
    .event::before {
      content:"";
      position:absolute;
      left:-20px;
      top:3px;
      width:10px;
      height:10px;
      border-radius:999px;
      background:#2563eb;
      border:2px solid #fff;
      box-shadow:0 0 0 2px #2563eb;
    }
    .event-time {
      font-size:13px;
      color:#6b7280;
    }
    .event-status {
      font-size:14px;
      font-weight:500;
    }
    .event-location {
      font-size:13px;
      color:#4b5563;
    }
    .error {
      margin-top:8px;
      padding:10px 12px;
      border-radius:8px;
      background:#fef2f2;
      color:#b91c1c;
      border:1px solid #fecaca;
      font-size:14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Spåra din beställning</h1>
    <p>Skriv in ditt 4PX-spårningsnummer nedan för att se status på ditt paket. Du hittar numret i din orderbekräftelse (börjar nästan alltid med 4PX och slutar med CN).</p>

    <div class="tabs">
      <button class="tab">Spårningsnummer</button>
    </div>

    <form id="track-form">
      <div class="row">
        <input
          type="text"
          id="input"
          placeholder="4PX-nummer, t.ex. 4PX3002..."
          autocomplete="off"
        />
        <button type="submit" class="primary" id="submit-btn">Spåra</button>
      </div>
    </form>

    <div id="error" class="error" style="display:none;"></div>

    <div id="result" style="display:none;">
      <div class="status-box">
        <div><strong>Spårningsnummer:</strong> <span id="res-tn"></span></div>
        <div><strong>Status:</strong> <span id="res-status"></span></div>
        <div><strong>PostNord nr:</strong> <span id="res-postnord"></span></div>
        <div><strong>Senast uppdaterad:</strong> <span id="res-updated"></span></div>
        <div id="res-postnord-link" style="margin-top:4px;"></div>
      </div>

      <h3 style="margin-top:20px;">Händelser</h3>
      <div id="events" class="timeline"></div>
    </div>
  </div>

  <script>
  const input = document.getElementById("input");
  const form = document.getElementById("track-form");
  const btn = document.getElementById("submit-btn");
  const errorBox = document.getElementById("error");
  const resultBox = document.getElementById("result");

  function formatDate(dt) {
    if (!dt) return "";
    const d = new Date(dt);
    if (isNaN(d.getTime())) return dt;
    return d.toLocaleString("sv-SE");
  }

  // Försök översätta Ship24-eventtexter till svenska
  function translateEventStatus(status) {
    if (!status) return "";
    const s = status.toLowerCase();

    if (
      s.includes("delivered to the recipient's mailbox") ||
      s.includes("delivered to the recipients mailbox")
    ) {
      return "Försändelsen har levererats till mottagarens brevlåda.";
    }
    if (s.includes("has been loaded")) {
      return "Försändelsen har lastats.";
    }
    if (s.includes("is being processed at our sorting center")) {
      return "Försändelsen hanteras på vår sorteringsterminal.";
    }
    if (s.includes("is under transportation")) {
      return "Försändelsen är under transport.";
    }
    if (
      s.includes(
        "has been handed over to a partner for transportation to the final destination"
      )
    ) {
      return "Försändelsen har överlämnats till en partner för vidare transport till slutdestinationen.";
    }
    if (s.includes("shipping information received")) {
      return "Fraktinformation har mottagits.";
    }
    if (s.includes("parcel information received")) {
      return "Paketinformation har mottagits.";
    }
    if (s.includes("we have received a notification from your shipper")) {
      return "Vi har fått information från avsändaren om att en försändelse förbereds åt dig.";
    }
    if (s.includes("shipment picked up")) {
      return "Försändelsen har hämtats upp.";
    }
    if (s.includes("shipment arrived at facility and measured")) {
      return "Försändelsen har ankommit till terminal och hanteras.";
    }
    if (s.includes("depart from facility to service provider")) {
      return "Försändelsen har lämnat terminalen för vidare transport.";
    }
    if (s.includes("arrival to the destination airport")) {
      return "Försändelsen har ankommit till destinationsflygplats.";
    }
    if (s.includes("departure from the original airport")) {
      return "Försändelsen har lämnat ursprungsflygplatsen.";
    }
    if (s.includes("released from customs: customs cleared")) {
      return "Försändelsen har klarerats i tullen.";
    }
    if (s.includes("arrive in transit center")) {
      return "Försändelsen har ankommit till omlastningscentral.";
    }
    if (s.includes("parcel outbound from transit center")) {
      return "Försändelsen har lämnat omlastningscentral.";
    }

    // Okänd text → visa originalet senare
    return "";
  }

  function updateUrlWithTrackingNumber(value) {
    const newUrl =
      window.location.pathname + "?tn=" + encodeURIComponent(value);
    window.history.replaceState(null, "", newUrl);
  }

  async function runTracking(value, opts = { updateUrl: true }) {
    const tn = (value || "").trim();
    if (!tn) return;

    if (opts.updateUrl) {
      updateUrlWithTrackingNumber(tn);
    }

    errorBox.style.display = "none";
    resultBox.style.display = "none";
    btn.disabled = true;

    try {
      const url = `/api/track?value=${encodeURIComponent(tn)}&mode=tracking`;
      const res = await fetch(url);
      const data = await res.json();

      if (!data.ok) {
        throw new Error(
          data.error || "Kunde inte hitta någon försändelse. Kontrollera numret."
        );
      }

      // Huvudinfo
      document.getElementById("res-tn").textContent =
        data.trackingNumber || "-";
      document.getElementById("res-status").textContent =
        data.statusSwedish || data.statusMilestone || "-";
      document.getElementById("res-postnord").textContent =
        data.postnordNumber || "Inte tilldelat ännu";
      document.getElementById("res-updated").textContent = formatDate(
        data.lastUpdate
      );

      const linkBox = document.getElementById("res-postnord-link");
      if (data.postnordNumber) {
        linkBox.innerHTML = `<a class="link" href="https://portal.postnord.com/tracking/details/${encodeURIComponent(
          data.postnordNumber
        )}" target="_blank" rel="noopener noreferrer">Öppna i PostNord</a>`;
      } else {
        linkBox.textContent =
          "När PostNord-spårningsnumret har skapats kan du spåra i PostNords app.";
      }

      // Händelser
      const eventsEl = document.getElementById("events");
      eventsEl.innerHTML = "";
      (data.events || []).forEach((ev) => {
        const original = ev.status || "";
        const translated = translateEventStatus(original);
        const text = translated || original;

        const div = document.createElement("div");
        div.className = "event";
        div.innerHTML = `
          <div class="event-time">${formatDate(ev.datetime)}</div>
          <div class="event-status">${text}</div>
          <div class="event-location">${ev.location || ""}</div>`;
        eventsEl.appendChild(div);
      });

      resultBox.style.display = "block";
    } catch (err) {
      errorBox.textContent = err.message || "Något gick fel.";
      errorBox.style.display = "block";
    } finally {
      btn.disabled = false;
    }
  }

  // När man trycker på "Spåra"
  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const value = input.value.trim();
    runTracking(value, { updateUrl: true });
  });

  // När sidan laddas med ?tn=...
  window.addEventListener("DOMContentLoaded", () => {
    const params = new URLSearchParams(window.location.search);
    const tn = params.get("tn");
    if (tn) {
      input.value = tn;
      // Vi uppdaterar INTE URL igen här, den är redan rätt
      runTracking(tn, { updateUrl: false });
    }
  });
</script>

