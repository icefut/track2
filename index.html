<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Sp√•ra din best√§llning | Icefot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --bg-soft: #020617;
      --card-bg: #020617;
      --card-border: rgba(148, 163, 184, 0.25);
      --accent: #2563eb;
      --accent-soft: rgba(37, 99, 235, 0.15);
      --accent-strong: #1d4ed8;
      --text: #e5e7eb;
      --text-soft: #9ca3af;
      --text-muted: #6b7280;
      --danger: #f97373;
      --success: #22c55e;
      --radius-xl: 18px;
      --radius-lg: 12px;
      --radius-pill: 999px;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.7);
      --shadow-subtle: 0 10px 30px rgba(15, 23, 42, 0.5);
      --timeline-line: rgba(148, 163, 184, 0.5);
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background:
        radial-gradient(circle at top, #1d4ed8 0, transparent 40%),
        radial-gradient(circle at bottom, #0f172a 0, #020617 55%);
      color: var(--text);
    }

    body {
      min-height: 100vh;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 32px 16px 40px;
    }

    .page {
      width: 100%;
      max-width: 960px;
    }

    /* HEADER */

    .header-card {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.7));
      border-radius: var(--radius-xl);
      border: 1px solid rgba(148, 163, 184, 0.25);
      padding: 20px 22px;
      margin-bottom: 18px;
      box-shadow: var(--shadow-soft);
      display: flex;
      align-items: center;
      gap: 18px;
    }

    .header-icon {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, #ffffff, #60a5fa);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #1e293b;
      font-size: 24px;
      font-weight: 700;
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.6);
      flex-shrink: 0;
    }

    .header-text-main {
      font-size: 22px;
      font-weight: 600;
      letter-spacing: 0.01em;
    }

    .header-text-sub {
      font-size: 14px;
      color: var(--text-soft);
      margin-top: 2px;
    }

    /* FORM CARD */

    .card {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.94));
      border-radius: var(--radius-xl);
      border: 1px solid var(--card-border);
      padding: 20px 22px 22px;
      box-shadow: var(--shadow-soft);
      margin-bottom: 18px;
    }

    .tabs {
      display: flex;
      background: rgba(15, 23, 42, 0.9);
      border-radius: var(--radius-pill);
      padding: 4px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      margin-bottom: 16px;
    }

    .tab {
      flex: 1;
      border-radius: var(--radius-pill);
      border: none;
      padding: 8px 12px;
      font-size: 13px;
      font-weight: 600;
      cursor: default;
      color: #e5e7eb;
      background: var(--accent);
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.6);
    }

    .track-form {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: stretch;
    }

    .track-input-wrap {
      flex: 1;
      min-width: 0;
    }

    .track-input-label {
      font-size: 12px;
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    .track-input {
      width: 100%;
      padding: 11px 12px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.55);
      background: rgba(15, 23, 42, 0.85);
      color: var(--text);
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease,
        background 0.15s ease;
    }

    .track-input::placeholder {
      color: rgba(148, 163, 184, 0.7);
    }

    .track-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.4);
      background: rgba(15, 23, 42, 0.95);
    }

    .primary-btn {
      padding: 13px 20px;
      border-radius: 10px;
      border: none;
      background: radial-gradient(circle at 30% 20%, #3b82f6, #1d4ed8);
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 14px 30px rgba(37, 99, 235, 0.6);
      transition: transform 0.08s ease, box-shadow 0.08s ease,
        filter 0.08s ease;
    }

    .primary-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 40px rgba(37, 99, 235, 0.75);
      filter: brightness(1.05);
    }

    .primary-btn:active {
      transform: translateY(0);
      box-shadow: 0 10px 22px rgba(37, 99, 235, 0.6);
    }

    .primary-btn:disabled {
      opacity: 0.7;
      cursor: wait;
      box-shadow: none;
      filter: grayscale(0.2);
    }

    .primary-btn-icon {
      font-size: 16px;
    }

    /* STATUS SUMMARY */

    .summary-grid {
      display: grid;
      grid-template-columns: 2.3fr 2fr;
      gap: 18px;
      margin-top: 18px;
    }

    @media (max-width: 768px) {
      .summary-grid {
        grid-template-columns: 1fr;
      }
    }

    .summary-panel {
      background: rgba(15, 23, 42, 0.95);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(148, 163, 184, 0.45);
      padding: 14px 14px 14px;
    }

    .summary-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
    }

    .summary-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
    }

    .status-pill {
      border-radius: var(--radius-pill);
      padding: 5px 10px;
      font-size: 12px;
      font-weight: 600;
      background: rgba(22, 163, 74, 0.15);
      color: #4ade80;
      border: 1px solid rgba(34, 197, 94, 0.5);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #4ade80;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.25);
    }

    .status-pill--warning {
      background: rgba(234, 179, 8, 0.12);
      color: #fde047;
      border-color: rgba(202, 138, 4, 0.6);
    }

    .status-pill--danger {
      background: rgba(239, 68, 68, 0.12);
      color: #fb7185;
      border-color: rgba(239, 68, 68, 0.7);
    }

    .status-main {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .summary-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 13px;
      margin-top: 2px;
    }

    .summary-row-label {
      color: var(--text-muted);
    }

    .summary-row-value {
      color: var(--text);
      font-weight: 500;
      word-break: break-all;
      text-align: right;
    }

    .link {
      color: #60a5fa;
      text-decoration: none;
      font-weight: 500;
      font-size: 13px;
    }

    .link:hover {
      text-decoration: underline;
    }

    /* PROGRESS BAR */

    .progress-wrapper {
      background: rgba(15, 23, 42, 0.98);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(148, 163, 184, 0.45);
      padding: 10px 12px 12px;
    }

    .progress-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.15em;
      margin-bottom: 10px;
    }

    .progress-steps {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      position: relative;
      padding-top: 4px;
    }

    .progress-line {
      position: absolute;
      top: 14px;
      left: 0;
      right: 0;
      height: 2px;
      background: rgba(55, 65, 81, 0.8);
      z-index: 0;
    }

    .progress-line-fill {
      position: absolute;
      top: 14px;
      left: 0;
      height: 2px;
      background: linear-gradient(
        90deg,
        #60a5fa,
        #2563eb
      );
      z-index: 1;
      width: 0%;
      transition: width 0.25s ease;
    }

    .progress-step {
      position: relative;
      z-index: 2;
      text-align: center;
      flex: 1;
    }

    .progress-dot {
      width: 12px;
      height: 12px;
      border-radius: 999px;
      border: 2px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.98);
      margin: 0 auto 4px;
      box-shadow: 0 0 0 3px rgba(15, 23, 42, 0.98);
    }

    .progress-step-label {
      font-size: 11px;
      color: var(--text-muted);
      max-width: 80px;
      margin: 0 auto;
    }

    .progress-step--active .progress-dot {
      border-color: #60a5fa;
      background: #60a5fa;
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.4);
    }

    .progress-step--active .progress-step-label {
      color: #e5e7eb;
      font-weight: 600;
    }

    /* ERROR / EMPTY */

    .alert {
      margin-top: 12px;
      border-radius: var(--radius-lg);
      padding: 10px 12px;
      font-size: 13px;
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }

    .alert--error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(248, 113, 113, 0.7);
      color: #fecaca;
    }

    .alert--info {
      background: rgba(37, 99, 235, 0.07);
      border: 1px solid rgba(59, 130, 246, 0.6);
      color: #bfdbfe;
    }

    .alert-icon {
      font-size: 18px;
      line-height: 1;
      margin-top: 1px;
    }

    /* EVENTS */

    .events-card {
      background: rgba(15, 23, 42, 0.96);
      border-radius: var(--radius-xl);
      border: 1px solid var(--card-border);
      padding: 18px 22px 20px;
      box-shadow: var(--shadow-subtle);
      margin-top: 18px;
    }

    .events-title-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 10px;
    }

    .events-title {
      font-size: 15px;
      font-weight: 600;
    }

    .events-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .timeline {
      margin-top: 10px;
      position: relative;
      padding-left: 16px;
    }

    .timeline:before {
      content: "";
      position: absolute;
      left: 7px;
      top: 3px;
      bottom: 6px;
      border-left: 1px dashed var(--timeline-line);
    }

    .event {
      position: relative;
      padding-left: 14px;
      margin-bottom: 14px;
    }

    .event:last-child {
      margin-bottom: 2px;
    }

    .event-dot {
      position: absolute;
      left: -1px;
      top: 5px;
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: #4b5563;
      box-shadow: 0 0 0 3px rgba(15, 23, 42, 1);
    }

    .event--latest .event-dot {
      background: #60a5fa;
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.6);
    }

    .event-time {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 1px;
    }

    .event-status {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 1px;
      color: #e5e7eb;
    }

    .event-location {
      font-size: 12px;
      color: var(--text-soft);
    }

    @media (max-width: 640px) {
      body {
        padding-top: 20px;
      }

      .header-card {
        padding: 16px 16px;
      }

      .card {
        padding: 16px 16px 18px;
      }

      .events-card {
        padding: 16px;
      }

      .header-text-main {
        font-size: 19px;
      }
    }
  </style>
</head>
<body>
  <main class="page">
    <!-- Header -->
    <section class="header-card">
      <div class="header-icon">üì¶</div>
      <div>
        <div class="header-text-main">Sp√•ra din best√§llning</div>
        <div class="header-text-sub">
          Ange ditt 4PX-sp√•rningsnummer f√∂r att se status p√• ditt paket.
        </div>
      </div>
    </section>

    <!-- Search + summary -->
    <section class="card">
      <div class="tabs">
        <button class="tab" type="button">Sp√•rningsnummer</button>
      </div>

      <form id="track-form" class="track-form">
        <div class="track-input-wrap">
          <div class="track-input-label">4PX-sp√•rningsnummer</div>
          <input
            id="tracking-input"
            class="track-input"
            type="text"
            placeholder="Till exempel 4PX3002‚Ä¶CN"
            autocomplete="off"
          />
        </div>
        <div>
          <button id="track-btn" class="primary-btn" type="submit">
            <span class="primary-btn-icon">üîç</span>
            <span>Sp√•ra</span>
          </button>
        </div>
      </form>

      <div id="error-box" class="alert alert--error" style="display:none;">
        <div class="alert-icon">‚ö†Ô∏è</div>
        <div id="error-text"></div>
      </div>

      <div id="info-box" class="alert alert--info" style="display:none;">
        <div class="alert-icon">‚ÑπÔ∏è</div>
        <div id="info-text"></div>
      </div>

      <div id="summary-section" style="display:none;">
        <div class="summary-grid">
          <!-- Left: main info -->
          <div class="summary-panel">
            <div class="summary-header-row">
              <div class="summary-label">Status</div>
              <div id="status-pill" class="status-pill">
                <span class="status-dot"></span>
                <span id="status-pill-text">‚Äì</span>
              </div>
            </div>
            <div class="status-main" id="status-main">‚Äì</div>

            <div class="summary-row">
              <div class="summary-row-label">Sp√•rningsnummer</div>
              <div class="summary-row-value" id="summary-tn">‚Äì</div>
            </div>
            <div class="summary-row">
              <div class="summary-row-label">PostNord-nummer</div>
              <div class="summary-row-value" id="summary-postnord">‚Äì</div>
            </div>
            <div class="summary-row">
              <div class="summary-row-label">Senast uppdaterad</div>
              <div class="summary-row-value" id="summary-updated">‚Äì</div>
            </div>

            <div id="postnord-link-box" style="margin-top:8px;"></div>
          </div>

          <!-- Right: progress -->
          <div class="progress-wrapper">
            <div class="progress-label">Leveransf√∂rlopp</div>
            <div class="progress-steps" id="progress-steps">
              <div class="progress-line"></div>
              <div class="progress-line-fill" id="progress-fill"></div>

              <div class="progress-step" data-step="0">
                <div class="progress-dot"></div>
                <div class="progress-step-label">Registrerad</div>
              </div>
              <div class="progress-step" data-step="1">
                <div class="progress-dot"></div>
                <div class="progress-step-label">P√• v√§g</div>
              </div>
              <div class="progress-step" data-step="2">
                <div class="progress-dot"></div>
                <div class="progress-step-label">Ute f√∂r leverans</div>
              </div>
              <div class="progress-step" data-step="3">
                <div class="progress-dot"></div>
                <div class="progress-step-label">Levererad</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Events -->
    <section id="events-card" class="events-card" style="display:none;">
      <div class="events-title-row">
        <div class="events-title">H√§ndelser</div>
        <div class="events-subtitle" id="events-subtitle">
          Senaste uppdateringar fr√•n fraktbolaget.
        </div>
      </div>
      <div id="events-list" class="timeline"></div>
    </section>
  </main>

  <script>
    const inputEl = document.getElementById("tracking-input");
    const formEl = document.getElementById("track-form");
    const btnEl = document.getElementById("track-btn");
    const summarySection = document.getElementById("summary-section");
    const eventsCard = document.getElementById("events-card");
    const eventsList = document.getElementById("events-list");
    const errorBox = document.getElementById("error-box");
    const errorText = document.getElementById("error-text");
    const infoBox = document.getElementById("info-box");
    const infoText = document.getElementById("info-text");

    const statusPill = document.getElementById("status-pill");
    const statusPillText = document.getElementById("status-pill-text");
    const statusMain = document.getElementById("status-main");
    const summaryTn = document.getElementById("summary-tn");
    const summaryPostnord = document.getElementById("summary-postnord");
    const summaryUpdated = document.getElementById("summary-updated");
    const postnordLinkBox = document.getElementById("postnord-link-box");
    const progressStepsEl = document.getElementById("progress-steps");
    const progressFillEl = document.getElementById("progress-fill");

    function formatDate(dt) {
      if (!dt) return "‚Äì";
      const d = new Date(dt);
      if (isNaN(d.getTime())) return dt;
      return d.toLocaleString("sv-SE");
    }

    // √ñvers√§tt vissa Ship24-texter till svenska
    function translateEventStatus(status) {
      if (!status) return "";
      const s = status.toLowerCase();

      if (s.includes("delivered to the recipient's mailbox") ||
          s.includes("delivered to the recipients mailbox")) {
        return "F√∂rs√§ndelsen har levererats till mottagarens brevl√•da.";
      }
      if (s.includes("has been loaded")) {
        return "F√∂rs√§ndelsen har lastats.";
      }
      if (s.includes("is being processed at our sorting center") ||
          s.includes("is being processed at our sorting centre")) {
        return "F√∂rs√§ndelsen hanteras p√• v√•r sorteringsterminal.";
      }
      if (s.includes("is under transportation")) {
        return "F√∂rs√§ndelsen √§r under transport.";
      }
      if (s.includes("has been handed over to a partner for transportation to the final destination")) {
        return "F√∂rs√§ndelsen har √∂verl√§mnats till en partner f√∂r vidare transport till slutdestinationen.";
      }
      if (s.includes("shipping information received")) {
        return "Fraktinformation har mottagits.";
      }
      if (s.includes("parcel information received")) {
        return "Paketinformation har mottagits.";
      }
      if (s.includes("we have received a notification from your shipper")) {
        return "Vi har f√•tt information fr√•n avs√§ndaren om att en f√∂rs√§ndelse f√∂rbereds √•t dig.";
      }
      if (s.includes("shipment picked up")) {
        return "F√∂rs√§ndelsen har h√§mtats upp.";
      }
      if (s.includes("shipment arrived at facility and measured")) {
        return "F√∂rs√§ndelsen har ankommit till terminal och hanteras.";
      }
      if (s.includes("depart from facility to service provider")) {
        return "F√∂rs√§ndelsen har l√§mnat terminalen f√∂r vidare transport.";
      }
      if (s.includes("arrival to the destination airport")) {
        return "F√∂rs√§ndelsen har ankommit till destinationsflygplats.";
      }
      if (s.includes("departure from the original airport")) {
        return "F√∂rs√§ndelsen har l√§mnat ursprungsflygplatsen.";
      }
      if (s.includes("released from customs: customs cleared")) {
        return "F√∂rs√§ndelsen har klarerats i tullen.";
      }
      if (s.includes("arrive in transit center")) {
        return "F√∂rs√§ndelsen har ankommit till omlastningscentral.";
      }
      if (s.includes("parcel outbound from transit center")) {
        return "F√∂rs√§ndelsen har l√§mnat omlastningscentral.";
      }

      return ""; // fall back till originaltext
    }

    function setUrlParam(tn) {
      const base = window.location.origin + window.location.pathname;
      const newUrl = tn ? base + "?tn=" + encodeURIComponent(tn) : base;
      window.history.replaceState({}, "", newUrl);
    }

    function resetUI() {
      errorBox.style.display = "none";
      infoBox.style.display = "none";
      summarySection.style.display = "none";
      eventsCard.style.display = "none";
      eventsList.innerHTML = "";
      progressFillEl.style.width = "0%";
      Array.from(
        progressStepsEl.querySelectorAll(".progress-step")
      ).forEach((step) => step.classList.remove("progress-step--active"));

      statusPill.classList.remove("status-pill--warning", "status-pill--danger");
    }

    function setProgressFromMilestone(milestone) {
      // Vi har 4 steg: 0=Registrerad,1=P√• v√§g,2=Ute f√∂r leverans,3=Levererad
      let stepIndex = 0;
      switch ((milestone || "").toLowerCase()) {
        case "info_received":
        case "data":
        case "pending":
          stepIndex = 0;
          break;
        case "in_transit":
        case "customs":
        case "available_for_pickup":
        case "exception":
          stepIndex = 1;
          break;
        case "out_for_delivery":
        case "failed_attempt":
          stepIndex = 2;
          break;
        case "delivered":
          stepIndex = 3;
          break;
        default:
          stepIndex = 1;
      }

      const steps = Array.from(
        progressStepsEl.querySelectorAll(".progress-step")
      );
      steps.forEach((step) => step.classList.remove("progress-step--active"));
      steps.forEach((step) => {
        const idx = Number(step.dataset.step || "0");
        if (idx <= stepIndex) {
          step.classList.add("progress-step--active");
        }
      });

      const maxIndex = steps.length - 1;
      const percent =
        maxIndex <= 0 ? 100 : (stepIndex / maxIndex) * 100;
      progressFillEl.style.width = percent + "%";
    }

    async function fetchTracking(tn) {
      resetUI();
      if (!tn) {
        errorText.textContent = "Fyll i ett 4PX-sp√•rningsnummer f√∂rst.";
        errorBox.style.display = "flex";
        return;
      }

      btnEl.disabled = true;

      try {
        const res = await fetch(
          "/api/track?value=" + encodeURIComponent(tn) + "&mode=tracking"
        );
        const data = await res.json();

        if (!data.ok) {
          throw new Error(
            data.error ||
              "Kunde inte hitta n√•gon f√∂rs√§ndelse. Kontrollera numret."
          );
        }

        // Uppdatera URL s√• kunden kan spara/dela l√§nken
        setUrlParam(data.trackingNumber || tn);

        // Huvudinfo
        const milestone = data.statusMilestone || null;
        const statusSwedish =
          data.statusSwedish || "Status ej tillg√§nglig √§nnu";

        statusMain.textContent = statusSwedish;
        summaryTn.textContent = data.trackingNumber || tn;
        summaryPostnord.textContent =
          data.postnordNumber || "Inte tilldelat √§nnu";
        summaryUpdated.textContent = formatDate(data.lastUpdate);

        statusPillText.textContent =
          milestone === "delivered"
            ? "Levererad"
            : milestone === "out_for_delivery"
            ? "Ute f√∂r leverans"
            : milestone === "in_transit"
            ? "P√• v√§g"
            : statusSwedish;

        // Statusf√§rg
        if (milestone === "delivered") {
          statusPill.classList.remove("status-pill--warning", "status-pill--danger");
        } else if (
          milestone === "exception" ||
          milestone === "failed_attempt"
        ) {
          statusPill.classList.add("status-pill--danger");
        } else if (
          milestone === "pending" ||
          milestone === "info_received"
        ) {
          statusPill.classList.add("status-pill--warning");
        }

        // PostNord-l√§nk
        if (data.postnordNumber) {
          postnordLinkBox.innerHTML =
            '<a class="link" href="https://portal.postnord.com/tracking/details/' +
            encodeURIComponent(data.postnordNumber) +
            '" target="_blank" rel="noopener noreferrer">√ñppna i PostNord</a>';
        } else {
          postnordLinkBox.textContent =
            "N√§r PostNord-numret har skapats kan du √§ven sp√•ra i PostNords app.";
        }

        // Progress
        setProgressFromMilestone(milestone);

        // H√§ndelser
        const events = Array.isArray(data.events) ? data.events.slice() : [];

        // Sortera senaste f√∂rst
        events.sort((a, b) => {
          const da = new Date(a.datetime || a.occurrenceDatetime || 0).getTime();
          const db = new Date(b.datetime || b.occurrenceDatetime || 0).getTime();
          return db - da;
        });

        if (!events.length) {
          infoText.textContent =
            "Vi har √§nnu inte f√•tt n√•gra h√§ndelser fr√•n fraktbolaget. Det betyder oftast att paketet √§r registrerat men inte p√•b√∂rjat sin resa.";
          infoBox.style.display = "flex";
        } else {
          eventsList.innerHTML = "";
          events.forEach((ev, idx) => {
            const container = document.createElement("div");
            container.className = "event" + (idx === 0 ? " event--latest" : "");

            const dot = document.createElement("div");
            dot.className = "event-dot";
            container.appendChild(dot);

            const timeEl = document.createElement("div");
            timeEl.className = "event-time";
            timeEl.textContent = formatDate(
              ev.datetime || ev.occurrenceDatetime || ""
            );
            container.appendChild(timeEl);

            const originalStatus = ev.status || "";
            const translated = translateEventStatus(originalStatus);
            const statusText = translated || originalStatus || "H√§ndelse";

            const statusEl = document.createElement("div");
            statusEl.className = "event-status";
            statusEl.textContent = statusText;
            container.appendChild(statusEl);

            const locationEl = document.createElement("div");
            locationEl.className = "event-location";
            locationEl.textContent = ev.location || "";
            container.appendChild(locationEl);

            eventsList.appendChild(container);
          });
        }

        summarySection.style.display = "block";
        eventsCard.style.display = "block";
      } catch (err) {
        console.error(err);
        errorText.textContent =
          err.message || "N√•got gick fel n√§r vi h√§mtade sp√•rningsinformationen.";
        errorBox.style.display = "flex";
      } finally {
        btnEl.disabled = false;
      }
    }

    formEl.addEventListener("submit", (e) => {
      e.preventDefault();
      const value = (inputEl.value || "").trim();
      fetchTracking(value);
    });

    // Auto-fyll fr√•n ?tn= n√§r sidan laddas
    (function initFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const tn = params.get("tn");
      if (tn) {
        inputEl.value = tn;
        fetchTracking(tn);
      }
    })();
  </script>
</body>
</html>
